const fileTreeStructure={system:["gui.css","settings.json","desktopBG.jpg","menuShortcuts.json","tests.html",{icons:["files.json"]}],programs:[{default:["Files.html","youTubeFilter.html","notepad.html","imageViewer.html","Calculator.html","tetrJS.html","appStore.html","settings.html"]}],documents:["message.txt","meme.png"]};async function fetchContent(fileURL){try{let time=(new Date).getTime();const response=await fetch(`${fileURL}?t=${time}`);if(response.ok){const extension=fileURL.split(".").pop().toLowerCase();if(["html","css","json","js","txt"].includes(extension)){return await response.text()}else{const arrayBuffer=await response.arrayBuffer();const binaryContent=new Uint8Array(arrayBuffer);let base64String="";for(let i=0;i<binaryContent.length;i+=65535){base64String+=btoa(String.fromCharCode(...binaryContent.slice(i,i+65535)))}return base64String}}else{console.error(`Error fetching file ${fileURL}: HTTP status ${response.status}`)}}catch(err){console.error(`Error fetching file ${fileURL}: ${err}`)}}async function installOS(fileTreeStructure,basePath="os/"){let tempFileContent={};let tempObjectContent={};for(let key in fileTreeStructure){if(Array.isArray(fileTreeStructure[key])){tempFileContent[key]={};for(let item of fileTreeStructure[key]){if(typeof item==="string"){let fileURL=`${basePath}${key}/${item}`;let content=await fetchContent(fileURL);saveRecord(fileURL.substring(3),content,"r");tempFileContent[key][item]=fileURL}else if(typeof item==="object"){for(let nestedKey in item){tempObjectContent=tempFileContent;tempObjectContent[key][nestedKey]=await installOS({[nestedKey]:item[nestedKey]},`${basePath}${key}/`);tempFileContent[key][nestedKey]=tempObjectContent[key][nestedKey][nestedKey]}}}}}return tempFileContent}const dbName="HardDrive";const storeName="FileData";let db;function deleteDB(){return new Promise((resolve,reject)=>{const deleteRequest=indexedDB.deleteDatabase(dbName);deleteRequest.onsuccess=function(){console.log(`Database ${dbName} deleted successfully.`);resolve()};deleteRequest.onerror=function(event){console.error(`Error deleting database: ${event.target.errorCode}`);reject(event.target.errorCode)};deleteRequest.onblocked=function(){console.warn(`Deletion of database ${dbName} is blocked.`);reject("Database deletion blocked")}})}function initDB(){return new Promise((resolve,reject)=>{const request=indexedDB.open(dbName,1);request.onupgradeneeded=function(event){db=event.target.result;if(!db.objectStoreNames.contains(storeName)){const objectStore=db.createObjectStore(storeName,{keyPath:"id",autoIncrement:true});objectStore.createIndex("path","path",{unique:true});objectStore.createIndex("data","data",{unique:false});objectStore.createIndex("access","access",{unique:false})}};request.onsuccess=function(event){db=event.target.result;resolve(db)};request.onerror=function(event){reject(`Database error: ${event.target.errorCode}`)}})}function saveRecord(path,data,access){return new Promise((resolve,reject)=>{const transaction=db.transaction([storeName],"readwrite");const objectStore=transaction.objectStore(storeName);const record={path:path,data:data,access:access};const request=objectStore.add(record);request.onsuccess=function(){resolve("Record added successfully")};request.onerror=function(event){reject(`Add failed: ${event.target.errorCode}`)}})}function getFileFromDB(path){return new Promise((resolve,reject)=>{const transaction=db.transaction([storeName],"readonly");const objectStore=transaction.objectStore(storeName);const index=objectStore.index("path");const request=index.get(path);request.onsuccess=function(event){if(event.target.result){resolve(event.target.result.data)}else{reject(`File not found: ${path}`)}};request.onerror=function(){reject(`Error retrieving file: ${path}`)}})}async function boot(){try{const styleElement=document.createElement("style");styleElement.type="text/css";styleElement.innerText=await getFileFromDB("system/gui.css");document.head.appendChild(styleElement);guiStart()}catch(error){console.error("Boot Error: ",error)}}var fileTree={};async function run(){try{const tonkenData=localStorage.getItem("authToken");if(!tonkenData){window.location.href="/login.html"}const token=JSON.parse(tonkenData).accesToken;const response=await fetch("/auth/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:token})});const data=await response.json();if(response.ok){alert("token ok.")}else{window.location.href="/login.html"}}catch(error){console.error("Network error:",error)}try{await deleteDB();await initDB();fileTree=await installOS(fileTreeStructure);await boot()}catch(error){console.error(error)}}run();async function guiStart(){await populateMenu();await parseSettings();loadDesktopBG()}let is12HourTime;let imagePath;async function parseSettings(){const settings=await getFileFromDB("system/settings.json");is12HourTime=JSON.parse(settings).timeFormat==="12h";imagePath=JSON.parse(settings).desktopBGPath}async function loadDesktopBG(){let base64ImageData=await getFileFromDB(imagePath);const binaryString=atob(base64ImageData);const dataArray=new Uint8Array(binaryString.length);for(let i=0;i<binaryString.length;i++){dataArray[i]=binaryString.charCodeAt(i)}const blob=new Blob([dataArray],{type:"image/jpg"});const objectUrl=URL.createObjectURL(blob);document.querySelector(":root").style.setProperty("--bgBlobURL",`url("${objectUrl}")`)}async function populateMenu(){let menu=document.getElementById("programs");menu.innerHTML="";const programListFile=await getFileFromDB("system/menuShortcuts.json");const programList=JSON.parse(programListFile);function appendToMenu(program,programData){let menuItem=document.createElement("li");const iconMatch=programData.match(/<!--.* microIcon="(.+?)".*-->/);let img=document.createElement("img");if(iconMatch){img.src=iconMatch[1]}img.classList.add("programMenuIcon");img.width,img.height=27;menuItem.appendChild(img);const programName=program.substring(program.lastIndexOf("/")+1);let textContainer=document.createElement("div");textContainer.classList.add("flexColCenter");textContainer.innerHTML=programName.substring(0,programName.lastIndexOf("."));menuItem.appendChild(textContainer);menuItem.classList="listButton flexRow";menuItem.onclick=menuItem.onclick=function(){openProgram(program)};menu.appendChild(menuItem)}for(let i=0;i<programList.length;i++){const programData=await getFileFromDB(programList[i]);if(programData!==null){appendToMenu(programList[i],programData)}}}let menuOpen=false;function toggleOpenmenu(){menuOpen=!menuOpen;if(menuOpen){document.getElementById("mainMenu").style.display="initial"}else{document.getElementById("mainMenu").style.display="none"}}function createWindow(currentWindowID,xPos,yPos,isAlert){let window=document.createElement("div");window.id=`win${currentWindowID}`;window.style.zIndex=isAlert?"999999":"5";window.classList.add("window","windowRidgeBorder");window.style.left=`${xPos}px`;window.style.top=`${yPos}px`;document.body.appendChild(window);return window}function createHeader(currentWindowID,programName,buttonCount){let header=document.createElement("div");header.id=`hed${currentWindowID}`;header.classList="menuHeader";const style=`width: calc(100% - var(--windowControlButtonWidth) * ${buttonCount})`;header.innerHTML=`<div class="menuHeaderTitle" style="${style}">${programName.substring(0,programName.lastIndexOf("."))}<div>`;return header}function createOverlay(){let overlay=document.createElement("div");overlay.style.position="fixed";overlay.style.top="0";overlay.style.left="0";overlay.style.width="100%";overlay.style.height="100%";overlay.style.cursor="grabbing";overlay.style.zIndex="9999";overlay.style.display="none";document.body.appendChild(overlay);return overlay}function createCloseButton(currentWindowID){let closeButton=document.createElement("button");closeButton.id=`close${currentWindowID}`;closeButton.classList="windowControlButton";closeButton.textContent="X";closeButton.onclick=function(){closeProgram(`win${currentWindowID}`,`men${currentWindowID}`)};return closeButton}function createMinimizeButton(currentWindowID){let minimizeButton=document.createElement("button");minimizeButton.id=`min${currentWindowID}`;minimizeButton.classList="windowControlButton";minimizeButton.textContent="_";minimizeButton.onclick=function(){minimizeProgram(`win${currentWindowID}`,`men${currentWindowID}`)};return minimizeButton}function createMaximizeButton(currentWindowID){let maximizeButton=document.createElement("button");maximizeButton.id=`max${currentWindowID}`;maximizeButton.classList="windowControlButton";maximizeButton.textContent="[ ]";maximizeButton.onclick=function(){toggleMaximizeProgram(`win${currentWindowID}`,`max${currentWindowID}`)};return maximizeButton}function createMenuBarButton(currentWindowID,programName){let menuBarButton=document.createElement("button");menuBarButton.id=`men${currentWindowID}`;menuBarButton.classList="h-100 solidButton";menuBarButton.style.border="var(--borderWidth) inset var(--secColorDark)";menuBarButton.textContent=programName;menuBarButton.addEventListener("mousedown",function(e){if(menuBarButton.style.border==="var(--borderWidth) inset var(--secColorDark)"){minimizeProgram(`win${currentWindowID}`,`men${currentWindowID}`)}else{bringWindowToFront(`win${currentWindowID}`,`men${currentWindowID}`)}});document.getElementById("programArea").appendChild(menuBarButton)}let windowCount=-1;let alertCount=-1;function createAlert(text){windowCount++;alertCount++;const currentWindowID=`${windowCount}`;let underlay=document.createElement("div");underlay.id=`underlay${currentWindowID}`;underlay.classList.add("underlay");document.body.appendChild(underlay);let window=createWindow(currentWindowID,document.body.clientWidth/2-150,200,true);let header=createHeader(currentWindowID,"Alert",1);window.appendChild(header);let message=document.createElement("p");message.classList.add("alertText");message.textContent=text;window.appendChild(message);let okButton=document.createElement("button");okButton.id=`close${currentWindowID}`;okButton.classList=" solidButton windowControlButton";okButton.textContent=" OK ";okButton.style.margin="0 auto 10px";okButton.style.display="block";okButton.onclick=function(){closeProgram(`win${currentWindowID}`,`men${currentWindowID}`);document.body.removeChild(underlay)};window.appendChild(okButton)}async function openProgram(program,withFile=null){if(menuOpen){toggleOpenmenu()}const programName=program.substring(program.lastIndexOf("/")+1);const data=await getFileFromDB(program);const noResizeMatch=data.match(/<!--.*noRS.*-->/);windowCount++;const currentWindowID=windowCount;let window=createWindow(currentWindowID,0,0);const buttonCount=noResizeMatch?2:3;let header;if(withFile){const directories=withFile.split("/");const fileName=directories.pop();header=createHeader(currentWindowID,fileName,buttonCount)}else{header=createHeader(currentWindowID,programName,buttonCount)}window.appendChild(header);let windowCtrlContainer=document.createElement("div");windowCtrlContainer.classList.add("windowCtrlContainer");header.appendChild(windowCtrlContainer);if(withFile){data=data.replace("<html>",`<html><!--path="${withFile}"-->`)}const sizeMatch=data.match(/<!--width="(\d+)" height="(\d+)".*-->/);const width=sizeMatch?sizeMatch[1]:"600";const height=sizeMatch?sizeMatch[2]:"400";const minimizeButton=createMinimizeButton(currentWindowID);windowCtrlContainer.appendChild(minimizeButton);let maximizeButton;if(!noResizeMatch){maximizeButton=createMaximizeButton(currentWindowID,width,height);windowCtrlContainer.appendChild(maximizeButton)}const closeButton=createCloseButton(currentWindowID);windowCtrlContainer.appendChild(closeButton);let overlay=createOverlay();window.addEventListener("click",e=>{if(e.target===closeButton||e.target===maximizeButton||e.target===minimizeButton){return}bringWindowToFront(`win${currentWindowID}`,`men${currentWindowID}`)});header.addEventListener("mousedown",function(e){if(e.target===closeButton||e.target===maximizeButton||e.target===minimizeButton){return}bringWindowToFront(`win${currentWindowID}`,`men${currentWindowID}`);e.preventDefault();overlay.style.display="block";const rect=window.getBoundingClientRect();const dragOffsetX=e.clientX-rect.left;const dragOffsetY=e.clientY-rect.top;function onMouseMove(e){window.style.position="absolute";const yResult=e.clientY-dragOffsetY;window.style.left=e.clientX-dragOffsetX+"px";window.style.top=(0>yResult?0:yResult)+"px"}function onMouseUp(){overlay.style.display="none";document.removeEventListener("mousemove",onMouseMove);document.removeEventListener("mouseup",onMouseUp)}document.addEventListener("mousemove",onMouseMove);document.addEventListener("mouseup",onMouseUp)});let iframe=document.createElement("iframe");iframe.id=`prog${currentWindowID}`;iframe.srcdoc=data;iframe.style.overflow="hidden";iframe.frameBorder="0";iframe.style.border="0";iframe.allowFullscreen=true;iframe.onload=function(){iframe.contentWindow.postMessage(`ID:[win${currentWindowID}`,"*");iframe.contentDocument.body.addEventListener("click",function(){bringWindowToFront(`win${currentWindowID}`,`men${currentWindowID}`)})};window.appendChild(iframe);createMenuBarButton(currentWindowID,programName);bringWindowToFront(`win${currentWindowID}`,`men${currentWindowID}`);registryResizingForProgram({noResizeMatch:noResizeMatch,iframeInitSize:{width:parseInt(width,10),height:parseInt(height,10)},elements:{programWindow:window,programHeader:header,programIframe:iframe,programMaximizeButton:maximizeButton,programOverlay:overlay}})}const cursorStatusMap={topBorder:"ns-resize",bottomBorder:"ns-resize",leftBorder:"ew-resize",rightBorder:"ew-resize",topLeftCorner:"nwse-resize",bottomRightCorner:"nwse-resize",topRightCorner:"nesw-resize",bottomLeftCorner:"nesw-resize",[undefined]:"default"};function registryResizingForProgram({noResizeMatch,iframeInitSize,elements}){const{programWindow,programHeader,programIframe,programMaximizeButton,programOverlay}=elements;const resizableZoneWidth=4;const headerRectHeight=programHeader.getBoundingClientRect().height;programIframe.style.height=`calc(100% - ${headerRectHeight}px)`;programIframe.style.width="100%";programWindow.style.width=iframeInitSize.width+"px";programWindow.style.height=iframeInitSize.height+headerRectHeight+"px";if(noResizeMatch)return;const isTopProgramWindow=()=>programWindow.style.zIndex==="5";const isMaximized=()=>programMaximizeButton.textContent!=="[ ]";let currentCursorStatus;const setCursor=e=>{if(!isTopProgramWindow()||isMaximized())return;if(!e){currentCursorStatus=undefined}else{const rect=programWindow.getBoundingClientRect();currentCursorStatus=checkCursorPosition(e,rect,resizableZoneWidth)}programWindow.style.cursor=cursorStatusMap[currentCursorStatus]};programWindow.addEventListener("mousemove",setCursor);programWindow.addEventListener("mousedown",e=>{if(e.target!==programWindow||!isTopProgramWindow()||isMaximized()){e.preventDefault();return}setCursor(e);programWindow.removeEventListener("mousemove",setCursor);programOverlay.style.display="block";function constrainMouseEventPosition(ev){const{clientX,clientY}=ev;const{innerWidth,innerHeight}=window;const programBar=document.getElementById("programBar");const barRect=programBar.getBoundingClientRect();const maxYDistance=innerHeight-barRect.height;const constrainedX=Math.max(0,Math.min(clientX,innerWidth));const constrainedY=Math.max(0,Math.min(clientY,maxYDistance));return{clientX:constrainedX,clientY:constrainedY}}const programWindowMinSize={width:210,height:headerRectHeight};const rect=programWindow.getBoundingClientRect();const{clientX:oldClientX,clientY:oldClientY}=e;const onResizing=e=>{let{clientX,clientY}=constrainMouseEventPosition(e);const deltaX=clientX-oldClientX;const deltaY=clientY-oldClientY;switch(currentCursorStatus){case"topBorder":const newHeight=Math.max(programWindowMinSize.height,rect.height-deltaY);programWindow.style.height=newHeight+"px";programWindow.style.top=rect.top+(rect.height-newHeight)+"px";break;case"bottomBorder":programWindow.style.height=Math.max(programWindowMinSize.height,rect.height+deltaY)+"px";break;case"leftBorder":const newWidth=Math.max(programWindowMinSize.width,rect.width-deltaX);programWindow.style.width=newWidth+"px";programWindow.style.left=rect.left+(rect.width-newWidth)+"px";break;case"rightBorder":programWindow.style.width=Math.max(programWindowMinSize.width,rect.width+deltaX)+"px";break;case"topLeftCorner":const newTopHeight=Math.max(programWindowMinSize.height,rect.height-deltaY);const newLeftWidth=Math.max(programWindowMinSize.width,rect.width-deltaX);programWindow.style.height=newTopHeight+"px";programWindow.style.top=rect.top+(rect.height-newTopHeight)+"px";programWindow.style.width=newLeftWidth+"px";programWindow.style.left=rect.left+(rect.width-newLeftWidth)+"px";break;case"bottomRightCorner":programWindow.style.height=Math.max(programWindowMinSize.height,rect.height+deltaY)+"px";programWindow.style.width=Math.max(programWindowMinSize.width,rect.width+deltaX)+"px";break;case"topRightCorner":const newRightWidth=Math.max(programWindowMinSize.width,rect.width+deltaX);const newTopHeightTR=Math.max(programWindowMinSize.height,rect.height-deltaY);programWindow.style.height=newTopHeightTR+"px";programWindow.style.top=rect.top+(rect.height-newTopHeightTR)+"px";programWindow.style.width=newRightWidth+"px";break;case"bottomLeftCorner":const newBottomHeight=Math.max(programWindowMinSize.height,rect.height+deltaY);const newLeftWidthBL=Math.max(programWindowMinSize.width,rect.width-deltaX);programWindow.style.height=newBottomHeight+"px";programWindow.style.width=newLeftWidthBL+"px";programWindow.style.left=rect.left+(rect.width-newLeftWidthBL)+"px";break;default:}};const onResizingCompleted=e=>{programOverlay.style.display="none";programWindow.addEventListener("mousemove",setCursor);document.removeEventListener("mousemove",onResizing);document.removeEventListener("mouseup",onResizingCompleted);setCursor()};document.addEventListener("mousemove",onResizing);document.addEventListener("mouseup",onResizingCompleted)})}function checkCursorPosition(e,rect,resizableZoneWidth){const{clientX,clientY}=e;const{x,y,width,height}=rect;const resizableRects={topLeftCorner:{x:x,y:y,width:resizableZoneWidth,height:resizableZoneWidth},topRightCorner:{x:x+width-resizableZoneWidth,y:y,width:resizableZoneWidth,height:resizableZoneWidth},bottomLeftCorner:{x:x,y:y+height-resizableZoneWidth,width:resizableZoneWidth,height:resizableZoneWidth},bottomRightCorner:{x:x+width-resizableZoneWidth,y:y+height-resizableZoneWidth,width:resizableZoneWidth,height:resizableZoneWidth},topBorder:{x:x+resizableZoneWidth,y:y,width:width-resizableZoneWidth*2,height:resizableZoneWidth},bottomBorder:{x:x+resizableZoneWidth,y:y+height-resizableZoneWidth,width:width-resizableZoneWidth*2,height:resizableZoneWidth},leftBorder:{x:x,y:y+resizableZoneWidth,width:resizableZoneWidth,height:height-resizableZoneWidth*2},rightBorder:{x:x+width-resizableZoneWidth,y:y+resizableZoneWidth,width:resizableZoneWidth,height:height-resizableZoneWidth*2}};const keys=Object.keys(resizableRects);const[currentCursorPosition]=keys.filter(key=>{return isContain({x:clientX,y:clientY},resizableRects[key])});return currentCursorPosition}function isContain(point,rect){return point.x>rect.x&&point.x<rect.x+rect.width&&point.y>rect.y&&point.y<rect.y+rect.height}function closeProgram(windowID,menuBarButtonID){document.getElementById(windowID).outerHTML="";let menuBarButton=document.getElementById(menuBarButtonID);if(menuBarButton!==null){menuBarButton.outerHTML=""}}function toggleMaximizeProgram(windowID,maximizeButtonID){const programWindow=document.getElementById(windowID);const button=document.getElementById(maximizeButtonID);if(button.textContent==="[ ]"){programWindow.setAttribute("preStyle",programWindow.getAttribute("style"));programWindow.style.width="100%";programWindow.style.height="calc(100vh - var(--programBarHeight))";programWindow.style.left=0;programWindow.style.top=0;"calc(100vh - var(--programBarHeight) - var(--headerBarHeight))";button.textContent="[]"}else{programWindow.style=programWindow.getAttribute("preStyle");programWindow.removeAttribute("preStyle");button.textContent="[ ]"}}function minimizeProgram(windowID,menuButtonID){document.getElementById(windowID).style.display="none";document.getElementById(menuButtonID).style.border="var(--borderWidth) outset var(--secColorDark)"}function bringWindowToFront(winID,buttID){document.getElementById(winID).style.display="initial";const windows=document.querySelectorAll('div[id^="win"]');windows.forEach(function(win){if(win.id===winID){win.style.zIndex="5";win.classList.add("activeWindowShadow");win.classList.remove("inactiveWindowShadow")}else{win.style.zIndex="4";win.classList.add("inactiveWindowShadow");win.classList.remove("activeWindowShadow");win.style.cursor="default"}});document.getElementById(buttID).style.border="var(--borderWidth) inset var(--secColorDark)"}function checkTime(i){return i<10?"0"+i:i}function getClockEndText(is12HourTime,isPM){return is12HourTime?isPM?" PM":" AM":""}const daysOfWeek=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];const monthsOfYear=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function getDayStr(num){return daysOfWeek[num]||"Invalid day"}function getMonthStr(num){return monthsOfYear[num]||"Invalid month"}function updateClock(){const today=new Date;let h=today.getHours();const isPM=is12HourTime&&h>=12;if(isPM){h-=12}if(h===0){h=12}const dayOfWeek=getDayStr(today.getDay());const day=today.getDate();const month=getMonthStr(today.getMonth());const mins=checkTime(today.getMinutes());document.getElementById("clock").innerHTML=`${dayOfWeek} ${month} ${day}<br/>${h}:${mins}${getClockEndText(is12HourTime,isPM)}`}setInterval(updateClock,1e3);function sendMessageToAllIframes(message){const iframes=document.getElementsByTagName("iframe");for(let i=0;i<iframes.length;i++){iframes[i].contentWindow.postMessage(message,"*")}}function checkFileExistsOrCreate(directory,fileName,fullDirPath){if(directory.hasOwnProperty(fileName)){window.top.postMessage("ALERT:[A file with that name already exists!")}else{directory[fileName]=fullDirPath;saveRecord(fullDirPath,"","rwd");return true}return false}function makeFile(directoryPath,fileTree,fileName,fullDirPath){const directories=directoryPath.split("/");const currentDirectory=directories.shift();if(directoryPath===""){return checkFileExistsOrCreate(fileTree,fileName,fullDirPath)}else if(currentDirectory&&fileTree.hasOwnProperty(currentDirectory)){if(directories.length===0){return checkFileExistsOrCreate(fileTree[currentDirectory],fileName,fullDirPath)}else{const nestedDirectoryPath=directories.join("/");return makeFile(nestedDirectoryPath,fileTree[currentDirectory],fileName,fullDirPath)}}else{window.top.postMessage("ALERT:[Could not create new file here.");return false}}const FILE_STATUSES={processing:"p",success:"s",fail:"f"};let fileCreationQueue=[];function waitForFileCreation(fileName){return new Promise(resolve=>{const checkFileStatus=()=>{const fileEntry=fileCreationQueue.find(entry=>entry.path===fileName);if(fileEntry){if(fileEntry.status===FILE_STATUSES.success){resolve(true)}else{resolve(false)}}else{requestAnimationFrame(checkFileStatus)}};requestAnimationFrame(checkFileStatus)})}function handleMakeFile(filePath){const fileEntry={path:filePath,status:FILE_STATUSES.processing};fileCreationQueue.push(fileEntry);const directories=filePath.split("/");const fileName=directories.pop();if(fileName===""){fileEntry.status=FILE_STATUSES.fail;return}const directoryPath=directories.join("/");if(makeFile(directoryPath,fileTree,fileName,filePath)){fileEntry.status=FILE_STATUSES.success;sendMessageToAllIframes("AF:"+JSON.stringify(fileTree),"*")}else{fileEntry.status=FILE_STATUSES.fail}}function makeFolder(directoryPath,fileTree,folderName,folderContents=null){const directories=directoryPath.split("/");const currentDirectory=directories.shift();if(directoryPath===""){if(!fileTree.hasOwnProperty(folderName)){if(folderContents!==null){fileTree[folderName]=folderContents}else{fileTree[folderName]={}}}}else if(currentDirectory&&fileTree.hasOwnProperty(currentDirectory)){if(directories.length===0){if(!fileTree[currentDirectory].hasOwnProperty(folderName)){if(folderContents!==null){fileTree[folderName]=folderContents}else{fileTree[folderName]={}}}}else{const nestedDirectoryPath=directories.join("/");makeFolder(nestedDirectoryPath,fileTree[currentDirectory],folderName)}}else{window.top.postMessage("ALERT:[Could not create new folder here.");return}}function handleMakeFolder(folderPath){const directories=folderPath.split("/");const folderName=directories.pop();if(folderName===""){return}const directoryPath=directories.join("/");makeFolder(directoryPath,fileTree,folderName);sendMessageToAllIframes("AF:"+JSON.stringify(fileTree),"*")}async function loadTests(){let testScript=document.createElement("script");testScript.type="text/javascript";const time=(new Date).getTime();try{const response=await fetch(`/os/system/__tests__.js?t=${time}`);if(response.ok){const content=await response.text();testScript.textContent=content;document.body.appendChild(testScript)}else{console.error(`Error fetching file HTTP status ${response.status}`)}}catch(err){console.error(`Error fetching file : ${err}`)}}window.onmessage=async function(e){if(e.origin!==window.origin||typeof e.data!=="string"){return}switch(true){case e.data.startsWith("ALERT:["):createAlert(e.data.slice(7));break;case e.data.startsWith("MK:D["):handleMakeFolder(e.data.slice(5));break;case e.data.startsWith("MK:F["):handleMakeFile(e.data.slice(5));break;case e.data.startsWith("OP:"):openProgram(e.data.slice(3));break;case e.data==="REQ:AF":sendMessageToAllIframes("AF:"+JSON.stringify(fileTree),"*");break;case e.data==="REQ:ICONS[files":const fileIcons=await getFileFromDB("system/icons/files.json");e.source.postMessage("ICONS:FILES>"+fileIcons,"*");case e.data==="REQ:OSV":e.source.postMessage("OSV:1.7","*");break;case e.data==="REQ:SS":const systemStyleSheet=await getFileFromDB("system/gui.css");e.source.postMessage("SS:"+systemStyleSheet,"*");break;case e.data==="RUNTESTS":await loadTests();await runTests();break;default:console.warn("Unknown request: "+e.data)}};